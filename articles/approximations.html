<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/3/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Approximate Inference for Multinomial Logit Models with Random Effects â€¢ mclogit</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Approximate Inference for Multinomial Logit Models with Random Effects">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mclogit</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">The statistical models</li>
    <li>
      <a href="../articles/conditional-logit.html">Conditional logit models</a>
    </li>
    <li>
      <a href="../articles/baseline-logit.html">Baseline-category logit models</a>
    </li>
    <li>
      <a href="../articles/baseline-and-conditional-logit.html">The relation between baseline logit and conditional logit models</a>
    </li>
    <li>
      <a href="../articles/random-effects.html">Random effects in baseline logit models and conditional logit models</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Technical aspects of model fitting</li>
    <li>
      <a href="../articles/fitting-mclogit.html">The IWLS algorithm used to fit conditional logit models</a>
    </li>
    <li>
      <a href="../articles/approximations.html">Approximate Inference for Multinomial Logit Models with Random Effects</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/melff/mclogit/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>




      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Approximate Inference for Multinomial Logit
Models with Random Effects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/melff/mclogit/blob/main/vignettes/approximations.Rmd" class="external-link"><code>vignettes/approximations.Rmd</code></a></small>
      <div class="hidden name"><code>approximations.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="the-problem">The problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>A crucial problem for inference about non-linear models with random
effects is that the likelihood function for such models involves
integrals for which no analytical solution exists.</p>
<p>For given values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math>
of the random effects the likelihood function of a conditional logit
model (and therefore also of a baseline-logit model) can be written in
the form</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>â„’</mi><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mo>â„“</mo><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mi>ğ›</mi><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğšº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>ğ›</mi><mi>â€²</mi><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathcal{L}_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})
=
\exp\left(\ell_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})\right)
=\exp
\left(
\ell(\boldsymbol{y}|\boldsymbol{b};\boldsymbol{\alpha})
-\frac12\ln\det(\boldsymbol{\Sigma})
-\frac12\boldsymbol{b}'\boldsymbol{\Sigma}^{-1}\boldsymbol{b}
\right)
</annotation></semantics></math></p>
<p>However, this â€œcomplete dataâ€ likelihood function cannot be used for
inference, because it depends on the unobserved random effects. To
arrive at a likelihood function that depends only on observed data, one
needs to used the following integrated likelihood function:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>â„’</mi><mtext mathvariant="normal">obs</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>âˆ«</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mo>â„“</mo><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>âˆ‚</mi><mi>ğ›</mi><mo>=</mo><mo>âˆ«</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mi>ğ›</mi><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğšº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>ğ›</mi><mi>â€²</mi><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>âˆ‚</mi><mi>ğ›</mi></mrow><annotation encoding="application/x-tex">
\mathcal{L}_{\text{obs}}(\boldsymbol{y})
=
\int
\exp\left(\ell_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})\right)
\partial \boldsymbol{b}
=
\int
\exp
\left(
\ell(\boldsymbol{y}|\boldsymbol{b};\boldsymbol{\alpha})
-\frac12\ln\det(\boldsymbol{\Sigma})
-\frac12\boldsymbol{b}'\boldsymbol{\Sigma}^{-1}\boldsymbol{b}
\right)
\partial \boldsymbol{b}
</annotation></semantics></math></p>
<p>In general, this integral cannot be â€œsolvedâ€, i.e.Â eliminated from
the formula by analytic means (it is â€œanalytically untractableâ€).
Instead, one will compute it either using numeric techniques (e.g.Â using
numerical quadrature) or approximate it using analytical techniques.
Unless there is only a single level of random effects numerical
quadrature can become computationally be demanding, that is, the
computation of the (log-)likelihood function and its derivatives can
take a lot of time even on modern, state-of-the-art computer hardware.
Yet approximations based on analytical techniques hand may lead to
biased estimates in particular in samples where the number of
observations relative to the number of random offects is small, but at
least they are much easier to compute and sometimes making inference
possible after all.</p>
<p>The package â€œmclogitâ€ supports to kinds of analytical approximations,
the Laplace approximation and what one may call the Solomon-Cox
appoximation. Both approximations are based on a quadratic expansion of
the integrand so that the thus modified integral does have a closed-form
solution, i.e.Â is analytically tractable.</p>
</div>
<div class="section level2">
<h2 id="the-laplace-approximation-and-pql">The Laplace approximation and PQL<a class="anchor" aria-label="anchor" href="#the-laplace-approximation-and-pql"></a>
</h2>
<div class="section level3">
<h3 id="laplace-approximation">Laplace approximation<a class="anchor" aria-label="anchor" href="#laplace-approximation"></a>
</h3>
<p>The (first-order) Laplace approximation is based on the quadratic
expansion the logarithm of the integrand, the complete-data
log-likelihood</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>â„“</mo><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>â‰ˆ</mo><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ›</mi><mo>âˆ’</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mi>â€²</mi><mover><mi>ğ‡</mi><mo accent="true">Ìƒ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ›</mi><mo>âˆ’</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğšº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ›</mi><mo>âˆ’</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mi>â€²</mi><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ›</mi><mo>âˆ’</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\ell_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})\approx
\ell(\boldsymbol{y}|\tilde{\boldsymbol{b}};\boldsymbol{\alpha})
-
\frac12
(\boldsymbol{b}-\tilde{\boldsymbol{b}})'
\tilde{\boldsymbol{H}}
(\boldsymbol{b}-\tilde{\boldsymbol{b}})
-\frac12\ln\det(\boldsymbol{\Sigma})
-\frac12(\boldsymbol{b}-\tilde{\boldsymbol{b}})'\boldsymbol{\Sigma}^{-1}(\boldsymbol{b}-\tilde{\boldsymbol{b}})
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{b}}</annotation></semantics></math>
is the solution to</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>âˆ‚</mi><msub><mo>â„“</mo><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>âˆ‚</mi><mi>ğ›</mi></mrow></mfrac><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">
\frac{\partial\ell_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})}{\partial\boldsymbol{b}}
= 0
</annotation></semantics></math></p>
<p>and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>ğ‡</mi><mo accent="true">Ìƒ</mo></mover><mo>=</mo><mi>ğ‡</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\tilde{\boldsymbol{H}}=\boldsymbol{H}(\tilde{\boldsymbol{b}})</annotation></semantics></math>
is the value of the negative Hessian with respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ‡</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>âˆ’</mo><mfrac><mrow><msup><mi>âˆ‚</mi><mn>2</mn></msup><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mi>ğ›</mi><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>âˆ‚</mi><mi>ğ›</mi><mi>âˆ‚</mi><mi>ğ›</mi><mi>â€²</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\boldsymbol{H}(\boldsymbol{b})=-\frac{\partial^2\ell(\boldsymbol{y}|\boldsymbol{b};\boldsymbol{\alpha})}{\partial\boldsymbol{b}\partial\boldsymbol{b}'}
</annotation></semantics></math></p>
<p>for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›</mi><mo>=</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover></mrow><annotation encoding="application/x-tex">\boldsymbol{b}=\tilde{\boldsymbol{b}}</annotation></semantics></math>.</p>
<p>Since this quadratic expansionâ€”let us call it
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>â„“</mo><mtext mathvariant="normal">Lapl</mtext><mo>*</mo></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ell^*_{\text{Lapl}}(\boldsymbol{y},\boldsymbol{b})</annotation></semantics></math>â€”is
a (multivariate) quadratic function of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math>,
the integral of its exponential does have a closed-form solution (the
relevant formula can be found in <span class="citation">Harville
(1997)</span>).</p>
<p>For purposes of estimation, the resulting approximate log-likelihood
is more useful:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>â„“</mo><mtext mathvariant="normal">Lapl</mtext><mo>*</mo></msubsup><mo>=</mo><mo>ln</mo><mo>âˆ«</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mo>â„“</mo><mtext mathvariant="normal">Lapl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>âˆ‚</mi><mi>ğ›</mi><mo>=</mo><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mi>â€²</mi><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğšº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>ğ‡</mi><mo accent="true">Ìƒ</mo></mover><mo>+</mo><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\ell^*_{\text{Lapl}}
=
\ln\int \exp(\ell_{\text{Lapl}}(\boldsymbol{y},\boldsymbol{b})) \partial\boldsymbol{b}
=
\ell(\boldsymbol{y}|\tilde{\boldsymbol{b}};\boldsymbol{\alpha})
-
\frac12\tilde{\boldsymbol{b}}'\boldsymbol{\Sigma}^{-1}\tilde{\boldsymbol{b}}
-
\frac12\ln\det(\boldsymbol{\Sigma})
-
\frac12\ln\det\left(\tilde{\boldsymbol{H}}+\boldsymbol{\Sigma}^{-1}\right).
</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="penalized-quasi-likelihood-pql">Penalized quasi-likelihood (PQL)<a class="anchor" aria-label="anchor" href="#penalized-quasi-likelihood-pql"></a>
</h3>
<p>If one disregards the dependence of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ‡</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{H}}</annotation></semantics></math>
on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‚</mi><annotation encoding="application/x-tex">\boldsymbol{\alpha}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math>,
then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{b}}</annotation></semantics></math>
maximizes not only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>â„“</mo><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ell_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})</annotation></semantics></math>
but also
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mo>â„“</mo><mtext mathvariant="normal">Lapl</mtext><mo>*</mo></msubsup><annotation encoding="application/x-tex">\ell^*_{\text{Lapl}}</annotation></semantics></math>.
This motivates the following IWLS/Fisher scoring equations for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\alpha}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{b}}</annotation></semantics></math>
(see <span class="citation">Breslow and Clayton (1993)</span> and <a href="fitting-mclogit.html">this page</a>):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>ğ—</mi><mi>â€²</mi><mi>ğ–</mi><mi>ğ—</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>ğ—</mi><mi>â€²</mi><mi>ğ–</mi><mi>ğ™</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>ğ™</mi><mi>â€²</mi><mi>ğ–</mi><mi>ğ—</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>ğ™</mi><mi>â€²</mi><mi>ğ–</mi><mi>ğ™</mi><mo>+</mo><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>ğ—</mi><mi>â€²</mi><mi>ğ–</mi><msup><mi>ğ²</mi><mo>*</mo></msup></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>ğ™</mi><mi>â€²</mi><mi>ğ–</mi><msup><mi>ğ²</mi><mo>*</mo></msup></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\begin{bmatrix}
\boldsymbol{X}'\boldsymbol{W}\boldsymbol{X} &amp; \boldsymbol{X}'\boldsymbol{W}\boldsymbol{Z} \\
\boldsymbol{Z}'\boldsymbol{W}\boldsymbol{X} &amp; \boldsymbol{Z}'\boldsymbol{W}\boldsymbol{Z} + \boldsymbol{\Sigma}^{-1}\\
\end{bmatrix}
\begin{bmatrix}
 \hat{\boldsymbol{\alpha}}\\
 \tilde{\boldsymbol{b}}\\
\end{bmatrix}
 =
\begin{bmatrix}
\boldsymbol{X}'\boldsymbol{W}\boldsymbol{y}^*\\
\boldsymbol{Z}'\boldsymbol{W}\boldsymbol{y}^*
\end{bmatrix}
\end{aligned}
</annotation></semantics></math></p>
<p>where</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ğ²</mi><mo>*</mo></msup><mo>=</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo>+</mo><mi>ğ™</mi><mi>ğ›</mi><mo>+</mo><msup><mi>ğ–</mi><mo>âˆ’</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>âˆ’</mo><mi>ğ›‘</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\boldsymbol{y}^* =  \boldsymbol{X}\boldsymbol{\alpha} +
\boldsymbol{Z}\boldsymbol{b} +
\boldsymbol{W}^{-}(\boldsymbol{y}-\boldsymbol{\pi})
</annotation></semantics></math></p>
<p>is the IWLS â€œworking dependend variableâ€ with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‚</mi><annotation encoding="application/x-tex">\boldsymbol{\alpha}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ–</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‘</mi><annotation encoding="application/x-tex">\boldsymbol{\pi}</annotation></semantics></math>
computed in an earlier iteration.</p>
<p>Substitutions lead to the equations:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ—</mi><msup><mi>ğ•</mi><mo>âˆ’</mo></msup><mi>ğ—</mi><mo stretchy="true" form="postfix">)</mo></mrow><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover><mo>=</mo><mi>ğ—</mi><msup><mi>ğ•</mi><mo>âˆ’</mo></msup><msup><mi>ğ²</mi><mo>*</mo></msup></mrow><annotation encoding="application/x-tex">
(\boldsymbol{X}\boldsymbol{V}^-\boldsymbol{X})\hat{\boldsymbol{\alpha}} =
\boldsymbol{X}\boldsymbol{V}^-\boldsymbol{y}^*
</annotation></semantics></math></p>
<p>and</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ™</mi><mi>â€²</mi><mi>ğ–</mi><mi>ğ™</mi><mo>+</mo><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>ğ›</mi><mo>=</mo><mi>ğ™</mi><mi>â€²</mi><mi>ğ–</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>ğ²</mi><mo>*</mo></msup><mo>âˆ’</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
(\boldsymbol{Z}'\boldsymbol{W}\boldsymbol{Z} +
\boldsymbol{\Sigma}^{-1})\boldsymbol{b} =
\boldsymbol{Z}'\boldsymbol{W}(\boldsymbol{y}^*-\boldsymbol{X}\boldsymbol{\alpha})
</annotation></semantics></math></p>
<p>which can be solved to compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\alpha}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{b}}</annotation></semantics></math>
(for given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğšº</mi><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math>)</p>
<p>Here</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ•</mi><mo>=</mo><msup><mi>ğ–</mi><mo>âˆ’</mo></msup><mo>+</mo><mi>ğ™</mi><mi>ğšº</mi><mi>ğ™</mi><mi>â€²</mi></mrow><annotation encoding="application/x-tex">
\boldsymbol{V} =
\boldsymbol{W}^-+\boldsymbol{Z}\boldsymbol{\Sigma}\boldsymbol{Z}'
</annotation></semantics></math></p>
<p>and</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ğ•</mi><mo>âˆ’</mo></msup><mo>=</mo><mi>ğ–</mi><mo>âˆ’</mo><mi>ğ–</mi><mi>ğ™</mi><mi>â€²</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ™</mi><mi>â€²</mi><mi>ğ–</mi><mi>ğ™</mi><mo>+</mo><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mi>ğ™</mi><mi>ğ–</mi></mrow><annotation encoding="application/x-tex">
\boldsymbol{V}^- = \boldsymbol{W}-
\boldsymbol{W}\boldsymbol{Z}'\left(\boldsymbol{Z}'\boldsymbol{W}\boldsymbol{Z}+\boldsymbol{\Sigma}^{-1}\right)^{-1}\boldsymbol{Z}\boldsymbol{W}
</annotation></semantics></math></p>
<p>Following <span class="citation">Breslow and Clayton (1993)</span>
the variance parameters in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğšº</mi><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math>
are estimated by minimizing</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>1</mn></msub><mo>=</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ•</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>ğ²</mi><mo>*</mo></msup><mo>âˆ’</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>ğ•</mi><mo>âˆ’</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>ğ²</mi><mo>*</mo></msup><mo>âˆ’</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
q_1 =
\det(\boldsymbol{V})+(\boldsymbol{y}^*-\boldsymbol{X}\boldsymbol{\alpha})\boldsymbol{V}^-(\boldsymbol{y}^*-\boldsymbol{X}\boldsymbol{\alpha})
</annotation></semantics></math></p>
<p>or the â€œREMLâ€ variant:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>2</mn></msub><mo>=</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ•</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>ğ²</mi><mo>*</mo></msup><mo>âˆ’</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>ğ•</mi><mo>âˆ’</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>ğ²</mi><mo>*</mo></msup><mo>âˆ’</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ—</mi><mi>â€²</mi><msup><mi>ğ•</mi><mo>âˆ’</mo></msup><mi>ğ—</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
q_2 =
\det(\boldsymbol{V})+(\boldsymbol{y}^*-\boldsymbol{X}\boldsymbol{\alpha})\boldsymbol{V}^-(\boldsymbol{y}^*-\boldsymbol{X}\boldsymbol{\alpha})+\det(\boldsymbol{X}'\boldsymbol{V}^{-}\boldsymbol{X})
</annotation></semantics></math></p>
<p>This motivates the following algorithm, which is strongly inspired by
the <code><a href="https://rdrr.io/pkg/MASS/man/glmmPQL.html" class="external-link">glmmPQL()</a></code> function in Brian Ripleyâ€™s <em>R</em> package
<a href="https://cran.r-project.org/package=MASS" class="external-link">MASS</a> <span class="citation">(Venables and Ripley 2002)</span>:</p>
<ol style="list-style-type: decimal">
<li>Create some suitable starting values for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‘</mi><annotation encoding="application/x-tex">\boldsymbol{\pi}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ–</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ²</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\boldsymbol{y}^*</annotation></semantics></math>
</li>
<li>Construct the â€œworking dependent variableâ€
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ²</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\boldsymbol{y}^*</annotation></semantics></math>
</li>
<li>Minimize
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>1</mn></msub><annotation encoding="application/x-tex">q_1</annotation></semantics></math>
(quasi-ML) or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>2</mn></msub><annotation encoding="application/x-tex">q_2</annotation></semantics></math>
(quasi-REML) iteratively (inner loop), to obtain an estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğšº</mi><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math>
</li>
<li>Obtain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>a</mi><mi>t</mi><mi>ğ›‚</mi></mrow><annotation encoding="application/x-tex">hat{\boldsymbol{\alpha}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{b}}</annotation></semantics></math>
based on the current estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğšº</mi><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math>
</li>
<li>Compute updated
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›ˆ</mi><mo>=</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo>+</mo><mi>ğ™</mi><mi>ğ›</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\eta}=\boldsymbol{X}\boldsymbol{\alpha} +
\boldsymbol{Z}\boldsymbol{b}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‘</mi><annotation encoding="application/x-tex">\boldsymbol{\pi}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ–</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>.</li>
<li>If the change in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›ˆ</mi><annotation encoding="application/x-tex">\boldsymbol{\eta}</annotation></semantics></math>
is smaller than a given tolerance criterion stop the algorighm and
declare it as converged. Otherwise go back to step 2 with the updated
values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\alpha}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›</mi><mo accent="true">Ìƒ</mo></mover><annotation encoding="application/x-tex">\tilde{\boldsymbol{b}}</annotation></semantics></math>.</li>
</ol>
<p>This algorithm is a modification of the <a href="fitting-mclogit.html">IWLS</a> algorithm used to fit conditional
logit models without random effects. Instead of just solving a linear
requatoin in step 3, it estimates a weighted linear mixed-effects model.
In contrast to <code><a href="https://rdrr.io/pkg/MASS/man/glmmPQL.html" class="external-link">glmmPQL()</a></code> it does not use the
<code>lme()</code> function from package <a href="https://cran.r-project.org/package=nlme" class="external-link">nlme</a> <span class="citation">(Pinheiro and Bates 2000)</span> for this, because the
weighting matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ–</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>
is non-diagonal. Instead,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>1</mn></msub><annotation encoding="application/x-tex">q_1</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>2</mn></msub><annotation encoding="application/x-tex">q_2</annotation></semantics></math>
are minimized using the function <code>nlminb</code> from the standard
<em>R</em> package â€œstatsâ€ or some other optimizer chosen by the
user.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-solomon-cox-approximation-and-mql">The Solomon-Cox approximation and MQL<a class="anchor" aria-label="anchor" href="#the-solomon-cox-approximation-and-mql"></a>
</h2>
<div class="section level3">
<h3 id="the-solomon-cox-approximation">The Solomon-Cox approximation<a class="anchor" aria-label="anchor" href="#the-solomon-cox-approximation"></a>
</h3>
<p>The (first-order) Solomon approximation <span class="citation">(Solomon and Cox 1992)</span> is based on the quadratic
expansion the integrand</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>â„“</mo><mtext mathvariant="normal">cpl</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>â‰ˆ</mo><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mn>ğŸ</mn><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>ğ </mi><mn>0</mn></msub><mi>â€²</mi><mi>ğ›</mi><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>ğ›</mi><mi>â€²</mi><msub><mi>ğ‡</mi><mn>0</mn></msub><mi>ğ›</mi><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğšº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>ğ›</mi><mi>â€²</mi><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mi>ğ›</mi></mrow><annotation encoding="application/x-tex">
\ell_{\text{cpl}}(\boldsymbol{y},\boldsymbol{b})\approx
\ell(\boldsymbol{y}|\boldsymbol{0};\boldsymbol{\alpha})
+
\boldsymbol{g}_0'
\boldsymbol{b}
-
\frac12
\boldsymbol{b}'
\boldsymbol{H}_0
\boldsymbol{b}
-\frac12\ln\det(\boldsymbol{\Sigma})
-\frac12\boldsymbol{b}'\boldsymbol{\Sigma}^{-1}\boldsymbol{b}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ </mi><mi>_</mi><mn>0</mn><mo>=</mo><mi>ğ </mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>ğŸ</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{g}\_0=\boldsymbol{g}(\boldsymbol{0})</annotation></semantics></math>
is the gradient of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="postfix">âˆ¥</mo><mi>ğ›</mi><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ell(\boldsymbol{y}\|\boldsymbol{b};\boldsymbol{\alpha})</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ </mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>âˆ’</mo><mfrac><mrow><mi>âˆ‚</mi><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mi>ğ›</mi><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>âˆ‚</mi><mi>ğ›</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\boldsymbol{g}(\boldsymbol{b})=-\frac{\partial\ell(\boldsymbol{y}|\boldsymbol{b};\boldsymbol{\alpha})}{\partial\boldsymbol{b}}
</annotation></semantics></math></p>
<p>at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›</mi><mo>=</mo><mn>ğŸ</mn></mrow><annotation encoding="application/x-tex">\boldsymbol{b}=\boldsymbol{0}</annotation></semantics></math>,
while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ‡</mi><mi>_</mi><mn>0</mn><mo>=</mo><mi>ğ‡</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>ğŸ</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{H}\_0=\boldsymbol{H}(\boldsymbol{0})</annotation></semantics></math>
is the negative Hessian at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›</mi><mo>=</mo><mn>ğŸ</mn></mrow><annotation encoding="application/x-tex">\boldsymbol{b}=\boldsymbol{0}</annotation></semantics></math>.</p>
<p>Like before, the integral of the exponential this quadratic expansion
(which we refer to as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>â„“</mo><mtext mathvariant="normal">SC</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ell_{\text{SC}}(\boldsymbol{y},\boldsymbol{b})</annotation></semantics></math>)
has a closed-form solution, as does its logarithm, which is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>ln</mo><mo>âˆ«</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mo>â„“</mo><mtext mathvariant="normal">SC</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>,</mo><mi>ğ›</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>âˆ‚</mi><mi>ğ›</mi><mo>=</mo><mo>â„“</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo stretchy="false" form="prefix">|</mo><mn>ğŸ</mn><mo>;</mo><mi>ğ›‚</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msub><mi>ğ </mi><mn>0</mn></msub><mi>â€²</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ğ‡</mi><mn>0</mn></msub><mo>+</mo><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><msub><mi>ğ </mi><mn>0</mn></msub><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğšº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>ln</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ğ‡</mi><mn>0</mn></msub><mo>+</mo><msup><mi>ğšº</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\ln\int \exp(\ell_{\text{SC}}(\boldsymbol{y},\boldsymbol{b})) \partial\boldsymbol{b}
=
\ell(\boldsymbol{y}|\boldsymbol{0};\boldsymbol{\alpha})
-
\frac12\boldsymbol{g}_0'\left(\boldsymbol{H}_0+\boldsymbol{\Sigma}^{-1}\right)^{-1}\boldsymbol{g}_0
-
\frac12\ln\det(\boldsymbol{\Sigma})
-
\frac12\ln\det\left(\boldsymbol{H}_0+\boldsymbol{\Sigma}^{-1}\right).
</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="marginal-quasi-likelhood-mql">Marginal quasi-likelhood (MQL)<a class="anchor" aria-label="anchor" href="#marginal-quasi-likelhood-mql"></a>
</h3>
<p>The resulting estimation technique is very similar to PQL <span class="citation">(again, see Breslow and Clayton 1993 for a
discussion)</span>. The only difference is the construction of the
â€œworking dependentâ€ variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ²</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\boldsymbol{y}^*</annotation></semantics></math>.
With PQL it is constructed as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ğ²</mi><mo>*</mo></msup><mo>=</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo>+</mo><mi>ğ™</mi><mi>ğ›</mi><mo>+</mo><msup><mi>ğ–</mi><mo>âˆ’</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>âˆ’</mo><mi>ğ›‘</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{y}^* =
\boldsymbol{X}\boldsymbol{\alpha} + \boldsymbol{Z}\boldsymbol{b} +
\boldsymbol{W}^{-}(\boldsymbol{y}-\boldsymbol{\pi})</annotation></semantics></math>
while the MQL working dependent variable is just</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ğ²</mi><mo>*</mo></msup><mo>=</mo><mi>ğ—</mi><mi>ğ›‚</mi><mo>+</mo><msup><mi>ğ–</mi><mo>âˆ’</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ğ²</mi><mo>âˆ’</mo><mi>ğ›‘</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\boldsymbol{y}^* =  \boldsymbol{X}\boldsymbol{\alpha} +
\boldsymbol{W}^{-}(\boldsymbol{y}-\boldsymbol{\pi})
</annotation></semantics></math></p>
<p>so that the algorithm has the following steps:</p>
<ol style="list-style-type: decimal">
<li>Create some suitable starting values for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‘</mi><annotation encoding="application/x-tex">\boldsymbol{\pi}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ–</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ²</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\boldsymbol{y}^*</annotation></semantics></math>
</li>
<li>Construct the â€œworking dependent variableâ€
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ²</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\boldsymbol{y}^*</annotation></semantics></math>
</li>
<li>Minimize
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>1</mn></msub><annotation encoding="application/x-tex">q_1</annotation></semantics></math>
(quasi-ML) or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>2</mn></msub><annotation encoding="application/x-tex">q_2</annotation></semantics></math>
(quasi-REML) iteratively (inner loop), to obtain an estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğšº</mi><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math>
</li>
<li>Obtain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\alpha}}</annotation></semantics></math>
based on the current estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğšº</mi><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math>
</li>
<li>Compute updated
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›ˆ</mi><mo>=</mo><mi>ğ—</mi><mi>ğ›‚</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\eta}=\boldsymbol{X}\boldsymbol{\alpha}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›‘</mi><annotation encoding="application/x-tex">\boldsymbol{\pi}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ–</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>.</li>
<li>If the change in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›ˆ</mi><annotation encoding="application/x-tex">\boldsymbol{\eta}</annotation></semantics></math>
is smaller than a given tolerance criterion stop the algorighm and
declare it as converged. Otherwise go back to step 2 with the updated
values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›‚</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\alpha}}</annotation></semantics></math>.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-breslow.clayton:approximate.inference.glmm" class="csl-entry">
Breslow, Norman E., and David G. Clayton. 1993. <span>â€œApproximate
Inference in Generalized Linear Mixed Models.â€</span> <em>Journal of the
American Statistical Association</em> 88 (421): 9â€“25.
</div>
<div id="ref-harville:matrix.algebra" class="csl-entry">
Harville, David A. 1997. <em>Matrix Algebra from a Statisticianâ€™s
Perspective</em>. New York: Springer.
</div>
<div id="ref-nlme-book" class="csl-entry">
Pinheiro, JosÃ© C., and Douglas M. Bates. 2000. <em>Mixed-Effects Models
in s and s-PLUS</em>. New York: Springer. <a href="https://doi.org/10.1007/b98882" class="external-link">https://doi.org/10.1007/b98882</a>.
</div>
<div id="ref-Solomon.Cox:1992" class="csl-entry">
Solomon, P. J., and D. R. Cox. 1992. <span>â€œNonlinear Component of
Variance Models.â€</span> <em>Biometrika</em> 79 (1): 1â€“11. <a href="https://doi.org/10.1093/biomet/79.1.1" class="external-link">https://doi.org/10.1093/biomet/79.1.1</a>.
</div>
<div id="ref-MASS" class="csl-entry">
Venables, W. N., and B. D. Ripley. 2002. <em>Modern Applied Statistics
with s</em>. Fourth. New York: Springer. <a href="https://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">https://www.stats.ox.ac.uk/pub/MASS4/</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Elff.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
  <p class="preferably">Using <a href="https://preferably.amirmasoudabdol.name/?source=footer" class="external-link">preferably</a> template.</p>
</div>

      </footer>
</div>






  </body>
</html>
